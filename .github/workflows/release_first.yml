name: First Release
on:
  workflow_dispatch:
jobs:
  release:
    runs-on: windows-latest
    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Set up Firebase CLI
        run: npm install -g firebase-tools

      - name: Set up GitHub CLI
        run: choco install gh -y

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Java 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Update CHANGELOG.md [Unreleased] to 1.0.0
        shell: pwsh
        run: |
          $changelogPath = "CHANGELOG.md"
          $changelog = Get-Content $changelogPath
          $today = Get-Date -Format "yyyy-MM-dd"
          $changelog = $changelog -replace "## \[Unreleased\]", "## 1.0.0 ($today)"
          Set-Content $changelogPath $changelog

      - name: Set pubspec.yaml version to 1.0.0
        shell: pwsh
        run: |
          $pubspec = Get-Content "pubspec.yaml"
          $pubspec = $pubspec | ForEach-Object {
              if ($_ -match "^version:") { "version: 1.0.0" } else { $_ }
          }
          Set-Content "pubspec.yaml" $pubspec

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add pubspec.yaml CHANGELOG.md
          git commit -m "chore(release): 1.0.0"

      - name: Build Android APK
        run: |
          flutter build apk --release
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/Faunty-1.0.0.apk

      - name: Create GitHub Release (Android APK)
        run: |
          $apkPath = "build/app/outputs/flutter-apk/Faunty-1.0.0.apk"
          if (Test-Path $apkPath) {
            gh release create "v1.0.0" $apkPath --title "Release 1.0.0" --notes (Get-Content CHANGELOG.md | Select-String "## 1.0.0" -Context 0,50 | ForEach-Object { $_.Line })
          }
        shell: pwsh

      - name: Build Flutter web
        run: flutter build web

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_FAUNTY_2_0 }}
          channelId: live
          projectId: faunty-2-0

      - name: Done
        run: echo "First release 1.0.0 complete!"

      - name: Push changes to branch
        if: success()
        run: |
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
